name: ðŸ“¦ Cache Dependencies

on:
  schedule:
    # every day at 23:00
    - cron: '0 23 * * *'
  # allow manual trigger
  workflow_dispatch:

jobs:
  cache-management:
    name: ðŸ”„ Update Dependencies Cache
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    permissions:
      actions: write
      contents: read
    env:
      HUSKY: 0
      CACHE_PATH: ./.yarn/cache

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Generate cache key
        id: cache-key
        run: |
          HASH="${{ hashFiles('**/yarn.lock') }}"
          echo "key=${{ runner.os }}-Yarn-${{ github.ref_name }}-${HASH}" >> $GITHUB_OUTPUT
          echo "hash=${HASH}" >> $GITHUB_OUTPUT

      - name: Check Cache
        id: cache-check
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.CACHE_PATH }}
          key: ${{ steps.cache-key.outputs.key }}
          lookup-only: true

      - name: Install Dependencies
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: ./.github/actions/deps-install

      - name: Save Cache
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.CACHE_PATH }}
          key: ${{ steps.cache-key.outputs.key }}

      - name: Purge Cache
        if: steps.cache-check.outputs.cache-hit != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get all caches matching the pattern
          CACHES=$(gh cache list --json id,key --jq '.[] | select(.key | startswith("${{ runner.os }}-Yarn-")) | select(.key != "${{ steps.cache-key.outputs.key }}") | .id')

          # Delete old caches
          if [ -n "$CACHES" ]; then
            echo "Deleting old caches..."
            echo "$CACHES" | while read -r cache_id; do
              echo "Deleting cache ID: $cache_id"
              gh cache delete "$cache_id" || true
            done
            echo "Old caches deleted successfully"
          else
            echo "No old caches to delete"
          fi

      - name: Unchanged Cache
        if: steps.cache-check.outputs.cache-hit == 'true'
        run: |
          echo "âœ… Cache is up to date. Hash: ${{ steps.cache-key.outputs.hash }}"
          echo "No action needed."
