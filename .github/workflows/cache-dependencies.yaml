name: ðŸ“¦ Cache Dependencies

on:
  schedule:
    # every day at 23:00
    - cron: '0 23 * * *'
  # allow manual trigger
  workflow_dispatch:
    inputs:
      purge_cache:
        description: 'Purge all caches before running'
        required: false
        default: false
        type: boolean

jobs:
  cache-management:
    name: ðŸ”„ Update Dependencies Cache
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    permissions:
      actions: write
      contents: read
    env:
      HUSKY: 0
      CACHE_PATH: ./.yarn/cache

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Purge Yarn Caches
        if: ${{ inputs.purge_cache }}
        uses: ./.github/actions/purge-cache
        with:
          runner_os: ${{ runner.os }}
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Generate cache key
        id: cache-key
        run: |
          HASH="${{ hashFiles('**/yarn.lock') }}"
          echo "key=${{ runner.os }}-Yarn-${{ github.ref_name }}-${HASH}" >> $GITHUB_OUTPUT
          echo "hash=${HASH}" >> $GITHUB_OUTPUT

      - name: Check Cache
        id: cache-check
        if: ${{ !inputs.purge_cache }}
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.CACHE_PATH }}
          key: ${{ steps.cache-key.outputs.key }}
          lookup-only: true

      - name: Determine if rebuild needed
        id: should-rebuild
        run: |
          if [[ "${{ inputs.purge_cache }}" == "true" || "${{ steps.cache-check.outputs.cache-hit }}" != "true" ]]; then
            echo "rebuild=true" >> $GITHUB_OUTPUT
          else
            echo "rebuild=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Dependencies
        if: ${{ steps.should-rebuild.outputs.rebuild == 'true' }}
        uses: ./.github/actions/deps-install

      - name: Save Cache
        if: ${{ steps.should-rebuild.outputs.rebuild == 'true' }}
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.CACHE_PATH }}
          key: ${{ steps.cache-key.outputs.key }}

      - name: Purge Yarn Caches
        if:
          ${{ !inputs.purge_cache && steps.should-rebuild.outputs.rebuild ==
          'true' }}
        uses: ./.github/actions/purge-cache
        with:
          runner_os: ${{ runner.os }}
          exclude_key: ${{ steps.cache-key.outputs.key }}
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Unchanged Cache
        if: ${{ steps.should-rebuild.outputs.rebuild == 'false' }}
        run: |
          echo "âœ… Cache is up to date. Hash: ${{ steps.cache-key.outputs.hash }}"
          echo "No action needed."
