name: ğŸ”„ Continuous Integration

on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    - cron: '0 9 * * *' # every day at 9:00

permissions:
  contents: read
  # Allows coveralls to post coverage reports as PR comments
  # Enables updating PR description with coverage badges
  # Required for PR status checks
  pull-requests: write
  # Allows coveralls to create/update check runs
  # Enables the coverage status to appear in the PR checks section
  # Required for passing/failing the coverage check
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  git-checks:
    name: ğŸš¦ Git Checks
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/git.yaml

  build-checks:
    name: ğŸ—ï¸ Build Checks
    uses: ./.github/workflows/build.yaml
    with:
      cache-task: ${{ github.event_name != 'pull_request' }}

  post-reviews:
    name: ğŸ“„ Post Reviews
    uses: ./.github/workflows/review.yaml

  code-quality-checks:
    name: ğŸ” Code Quality Checks
    uses: ./.github/workflows/lint.yaml
    with:
      cache-task: ${{ github.event_name != 'pull_request' }}

  tests:
    name: ğŸ§ª Tests
    uses: ./.github/workflows/test.yaml
    with:
      cache-task: ${{ github.event_name != 'pull_request' }}

  code-quality-gate:
    name: ğŸ“Š Code Quality Gate
    needs: [code-quality-checks, tests, post-reviews]
    if: always()
    uses: ./.github/workflows/gate.yaml
    with:
      needs-context: ${{ toJSON(needs) }}
      gate-name: 'ğŸ“Š Code Quality Gate'

  cache-tasks:
    name: ğŸ’¾ Cache Tasks
    needs: [build-checks, code-quality-checks, tests]
    if: always() && github.event_name != 'pull_request'
    permissions:
      actions: write
      contents: read
    uses: ./.github/workflows/cache-tasks.yaml

  ready-to-integrate:
    name: ğŸš¢ Ready to Integrate
    needs: [git-checks, build-checks, code-quality-gate]
    if: always()
    uses: ./.github/workflows/gate.yaml
    with:
      needs-context: ${{ toJSON(needs) }}
      gate-name: 'ğŸš¢ Ready to Integrate'
